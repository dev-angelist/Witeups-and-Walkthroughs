---
description: https://tryhackme.com/r/room/postexploit
---

# Post-Exploitation Basics

<div align="left"><figure><img src="../.gitbook/assets/image (376).png" alt="" width="150"><figcaption></figcaption></figure></div>

This [room](https://tryhackme.com/r/room/postexploit) will cover all of the basics of post-exploitation; we'll talk everything from post-exploitation enumeration with powerview and bloodhound, dumping hashes and golden ticket attacks with mimikatz, basic information gathering using windows server tools and logs, and then we will wrap up this room talking about the basics of maintaining access with the persistence metaploit module and creating a backdoor into the machine to get an instant meterpreter shell if the system is ever shutdown or reset.

This room will be related to very real world applications and will most likely not help with any ctfs however this room will give you great starting knowledge of how to approach a network after you have gained a shell on a machine.

### Task 1 - Deploy machine <a href="#task-0-deploy-machine" id="task-0-deploy-machine"></a>

<figure><img src="../.gitbook/assets/image (379).png" alt=""><figcaption></figcaption></figure>

🎯 Target IP: `10.10.33.104` |  `10.10.123.2`

🖥️ `CONTROLLER\Administrator:P@$$W0rd`

Create a directory on the Desktop with the machine's name, and inside this directory, create another directory to store the materials and outputs needed to run the machine.

```
su
echo "10.10.33.104 win-server.thm" >> /etc/hosts

mkdir -p thm/win-server.thm
cd hm/win-server.thm
mkdir {nmap,content,exploits,scripts}
# At the end of the room
# To clean up the last line from the /etc/hosts file
sed -i '$ d' /etc/hosts
```

I'm using a personal KaliVM (eventually there's THM attacker box).

We can start clicking Start Machine and running THM vpn: `openvpn vpn_thm.ovpn` on Kali Machine.

Now, we can access to victim machine/room (windows server) via RDP or SSH into the machine. On KaliVM in addition to ssh, we've xfreerdp already installed.

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

### SSH/22

`ssh Administrator@win-server.thm`

<figure><img src="../.gitbook/assets/image (381).png" alt=""><figcaption></figcaption></figure>

I did a quick local enumeration, but I'll opt to use RDP.

### RDP/3389

`xfreerdp /u:Administrator /v:10.10.33.104 +clipboard /dynamic-resolution`

and insert psw into prompt

<figure><img src="../.gitbook/assets/image (382).png" alt=""><figcaption></figcaption></figure>

## Task 2 - Enumeration w/ Powerview

Powerview is a powerful powershell script from powershell empire that can be used for enumerating a domain after you have already gained a shell in the system.

<div align="left"><figure><img src="../.gitbook/assets/image (378).png" alt="" width="144"><figcaption></figcaption></figure></div>

1\) Start Powershell with the -ep parameter to bypass Powershell execution policy which allows you to easily run scripts: `powershell -ep bypass`

<figure><img src="../.gitbook/assets/image (383).png" alt=""><figcaption></figcaption></figure>

2\) Start PowerView: `. .\Downloads\PowerView.ps1`

3\) Enumerate the domain users: `Get-NetUser | select cn`

<figure><img src="../.gitbook/assets/image (384).png" alt=""><figcaption></figcaption></figure>

4\) Enumerate the domain groups: `Get-NetGroup -GroupName *admin*`

<figure><img src="../.gitbook/assets/image (385).png" alt=""><figcaption></figcaption></figure>

THM suggest us to utilize this really nice cheatsheet, that contains additional commands: [https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)

Than, we can continue the local enumeration using following commands:

* checking local account privileges: `whoami /priv`

<figure><img src="../.gitbook/assets/image (386).png" alt=""><figcaption></figcaption></figure>

* and local account groups: `whoami /groups`

<figure><img src="../.gitbook/assets/image (387).png" alt=""><figcaption></figcaption></figure>

* getting local users: `net users`

<figure><img src="../.gitbook/assets/image (389).png" alt=""><figcaption></figcaption></figure>

* and specific info about one of them (eg. admin2):&#x20;

<figure><img src="../.gitbook/assets/image (392).png" alt=""><figcaption></figcaption></figure>

discovering that Admin2 appartains at Administrators group.

* checking local groups: `net localgroup` and retrieve info about one group: `net localgroup "Administrators"`

<figure><img src="../.gitbook/assets/image (394).png" alt=""><figcaption></figcaption></figure>

* Retrieve info about user groups: `Get-NetGroup -UserName Admin2` and all member regarding a specifc group: `Get-NetGroupMember -GroupName "Administrators"`

<figure><img src="../.gitbook/assets/image (401).png" alt=""><figcaption></figcaption></figure>

* Obtaining info about DC (forest, SID, Policy and more): `Get-NetDomain` `Get-DomainSID` `Get-DomainPolicy` `Get-NetDomainController`

<figure><img src="../.gitbook/assets/image (404).png" alt=""><figcaption></figcaption></figure>

* Obtaining info about GPOs: `Get-NetGPO`

<figure><img src="../.gitbook/assets/image (405).png" alt=""><figcaption></figcaption></figure>

### 2.1 - What is the shared folder that is not set by default?

Using `Invoke-ShareFinder` we can enumerate shared folders, one of the main attack vectors in the AD context

<figure><img src="../.gitbook/assets/image (406).png" alt=""><figcaption></figcaption></figure>

The only one share folder not setted by defaul is Share.

{% hint style="info" %}
Share
{% endhint %}

### 2.2 - What operating system is running inside of the network besides Windows Server 2019?

`Get-NetComputer -fulldata | select cn, operatingsystem`

<figure><img src="../.gitbook/assets/image (403).png" alt=""><figcaption></figcaption></figure>

Eventually, we can check computers into the AD current domain: `Get-NetComputer` and computers active: `Get-NetComputer -Ping`

<figure><img src="../.gitbook/assets/image (402).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Windows 10 Enterprise Evaluation
{% endhint %}

### 2.3 - I've hidden a flag inside of the users find it

As already seen in the previous enumeration, the flag is present when enumerating users: `Get-NetUser | Select cn, objectsid`

(objectsid and adspath info is not needed to solve the task, but is useful for enumeration)

<figure><img src="../.gitbook/assets/image (399).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
POST{P0W3RV13W\_FTW}
{% endhint %}

## Task 3 - Enumeration w/ Bloodhound

<div align="left"><figure><img src="https://i.imgur.com/BAT2ZAH.png" alt="" width="188"><figcaption></figcaption></figure></div>

Bloodhound is a graphical interface that allows you to visually map out the network. This tool along with SharpHound which similar to PowerView takes the user, groups, trusts etc. of the network and collects them into .json files to be used inside of Bloodhound.

[BloodHound GitHub Repo - Legacy](https://github.com/SpecterOps/BloodHound-Legacy)

[SharpHound Documentation](https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound.html)

Well be focusing on how to collect the .json files and how to import them into Bloodhound.

SharpHound is already present into the machine.

### BloodHound Installation

Steps to do on attacker machine (Kali)

1\) `apt-get install bloodhound`   &#x20;

2\) `neo4j console`

3\) open browser and go to URL indicated by neo4j console (usually: [http://localhost:7474](http://localhost:7474))

insert default credentials -> neo4j:neo4j and click to connect.

<figure><img src="../.gitbook/assets/image (407).png" alt=""><figcaption></figcaption></figure>

### Getting loot w/ SharpHound

Steps to do on victim machine

1\) `powershell -ep bypass` same as with PowerView

2\) `. .\Downloads\SharpHound.ps1`   &#x20;

3\) `Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip`   &#x20;

(In this task i've accessed to victim machine via SSH: `ssh Administrator@win-server.thm)`

<figure><img src="../.gitbook/assets/image (409).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (411).png" alt=""><figcaption></figcaption></figure>

4\) Transfer the loot.zip folder to your Attacker Machine

to transfer loot file we can use a pscp (scp), we can install it using: `sudo apt-get install putty-tools`

then, loot file is located at: C:\Users\Administrator\20250111095928\_loot.zip

(Remember to replace '\\' with '/')

pscp Administrator@win-server.thm:/Users/Administrator/20250111095928\_loot.zip .

<figure><img src="../.gitbook/assets/image (410).png" alt=""><figcaption></figcaption></figure>

### Mapping the network w/ BloodHound -

1\) `bloodhound` Run this on your attacker machine not the victim machine

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

2\) Sign In using the same credentials you set with Neo4j and import loot file clicking to Import Graph











<div align="left"><img src="https://i.imgur.com/4LSMKBX.png" alt=""></div>

![](https://i.imgur.com/Eced2zF.png)

![](https://i.imgur.com/1orYd9p.png)

## Task 4 - Dumping hashes w/ mimikatz

\


<div align="left"><figure><img src="https://i.imgur.com/gCOtm0l.png" alt="" width="188"><figcaption></figcaption></figure></div>

![](https://i.imgur.com/qwNK9te.png)

![](https://i.imgur.com/aZjIrU7.png)

![](https://i.imgur.com/6KnPn03.png)

![](https://i.imgur.com/ihEcxFA.png)

## Task 5 - Golden Ticket Attacks w/ mimikatz

![](https://i.imgur.com/3Dnf16j.png)\


![](https://i.imgur.com/Yzq71aI.png)

\


<figure><img src="https://i.imgur.com/9ZIN20L.png" alt=""><figcaption></figcaption></figure>

![](https://i.imgur.com/iB0Io20.png)\


![](https://i.imgur.com/BYSud9C.png)

![](https://i.imgur.com/tp3N9gt.png)

## Task 6 - Enumeration w/ Server Manager

![](https://i.imgur.com/xk3fAdg.png)

![](https://i.imgur.com/LbWxEF5.png)

## Task 7 - Maintaining Access





## Resources

* [https://blog.harmj0y.net/](https://blog.harmj0y.net/)
* [https://adsecurity.org/?page\_id=1821](https://adsecurity.org/?page_id=1821)
* [https://metasploit.help.rapid7.com/docs/about-post-exploitation](https://metasploit.help.rapid7.com/docs/about-post-exploitation)\

* [http://www.pentest-standard.org/index.php/Post\_Exploitation](http://www.pentest-standard.org/index.php/Post_Exploitation)
* [https://offsec.red/mimikatz-cheat-sheet/](https://offsec.red/mimikatz-cheat-sheet/)
* [https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)

Tools/Malware Used -

* [https://github.com/gentilkiwi/mimikatz](https://github.com/gentilkiwi/mimikatz)
* [https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1](https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1)
* [https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1)
